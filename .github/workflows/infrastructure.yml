name: ðŸ—ï¸ Infrastructure Changes

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
  workflow_dispatch:

env:
  TF_VERSION: 1.5.0

jobs:
  terraform-plan:
    name: ðŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ðŸ”§ Terraform Init
      run: |
        cd infrastructure
        terraform init
        
    - name: ðŸ” Terraform Format Check
      run: |
        cd infrastructure
        terraform fmt -check
        
    - name: âœ… Terraform Validate
      run: |
        cd infrastructure
        terraform validate
        
    - name: ðŸ“‹ Terraform Plan
      run: |
        cd infrastructure
        terraform plan -out=tfplan
        
    - name: ðŸ“¦ Upload Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: infrastructure/tfplan

  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ðŸ”§ Terraform Init
      run: |
        cd infrastructure
        terraform init
        
    - name: ðŸ“¥ Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: infrastructure/
        
    - name: ðŸš€ Terraform Apply
      run: |
        cd infrastructure
        terraform apply -auto-approve tfplan
        
    - name: ðŸ“Š Terraform Output
      run: |
        cd infrastructure
        terraform output
        
    - name: ðŸ’¾ Save State Info
      run: |
        cd infrastructure
        terraform show -json > terraform-state.json
        
    - name: ðŸ“¤ Upload State Info
      uses: actions/upload-artifact@v4
      with:
        name: terraform-state
        path: infrastructure/terraform-state.json

  security-review:
    name: ðŸ”’ Security Review
    runs-on: ubuntu-latest
    needs: terraform-plan
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”§ Terraform Init
      run: |
        cd infrastructure
        terraform init -backend=false
        
    - name: ðŸ”’ Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: infrastructure/
        framework: terraform
        output_format: sarif
        output_file_path: checkov-report.sarif
        
    - name: ðŸ“¤ Upload Checkov scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov-report.sarif

  cost-estimation:
    name: ðŸ’° Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-plan
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”§ Terraform Init
      run: |
        cd infrastructure
        terraform init -backend=false
        
    - name: ðŸ“‹ Terraform Plan for Cost
      run: |
        cd infrastructure
        terraform plan -out=cost-plan
        
    - name: ðŸ’° Run Infracost
      uses: infracost/infracost-gh-action@master
      env:
        INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
      with:
        path: infrastructure/cost-plan
        terraform_plan_flags: -lock=false
        
    - name: ðŸ“Š Cost Comment
      uses: infracost/infracost-gh-action@master
      env:
        INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
      with:
        path: infrastructure/cost-plan
        terraform_plan_flags: -lock=false
        behavior: update
        
  documentation:
    name: ðŸ“š Update Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ðŸ”§ Terraform Init
      run: |
        cd infrastructure
        terraform init -backend=false
        
    - name: ðŸ“š Generate Terraform Docs
      uses: terraform-docs/gh-actions@main
      with:
        working-dir: infrastructure
        output-file: INFRASTRUCTURE.md
        output-method: inject
        git-push: "true"
